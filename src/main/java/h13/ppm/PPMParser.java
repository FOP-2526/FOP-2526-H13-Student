package h13.ppm;

import h13.ppm.image.PPMHeader;
import h13.ppm.image.PPMImage;
import h13.ppm.image.PixelColor;
import org.tudalgo.algoutils.student.annotation.DoNotTouch;
import org.tudalgo.algoutils.student.annotation.StudentImplementationRequired;

import java.io.IOException;
import java.io.InputStream;

/**
 * Parses a PPM encoded image from a given {@link InputStream}.
 */
public class PPMParser implements AutoCloseable {

    private final InputStream input;

    /**
     * Creates a new {@link PPMParser} that will read an image from the given {@link InputStream}
     *
     * @param input the {@link InputStream} to read from
     */
    @DoNotTouch
    public PPMParser(InputStream input) {
        this.input = input;
    }

    /**
     * Parses one complete image from the input.
     *
     * @return the parsed image
     * @throws IOException if an I/O error occurs
     */
    @StudentImplementationRequired("H13.1.1")
    public PPMImage parse() throws IOException {
        // TODO: H13.1.1
        return org.tudalgo.algoutils.student.Student.crash("H13.1.1 - Remove if implemented");
    }

    /**
     * Reads as many bytes as expected according to the image's width and height.
     *
     * @param width  the image's expected width
     * @param height the image's expected height
     * @return a 2-dimensional array containing pixel rows of the whole image
     * @throws IOException if an I/O error occurs
     */
    @StudentImplementationRequired("H13.1.1")
    public PixelColor[][] parsePixelData(int width, int height) throws IOException {
        // TODO: H13.1.1
        return org.tudalgo.algoutils.student.Student.crash("H13.1.1 - Remove if implemented");
    }

    /**
     * Parses the header from the input and returns its relevant information.
     * Only max color values of 255 are allowed.
     *
     * @return the parsed header
     * @throws IOException if an I/O error occur
     */
    @StudentImplementationRequired("H13.1.1")
    public PPMHeader parseHeader() throws IOException {
        // TODO: H13.1.1
        return org.tudalgo.algoutils.student.Student.crash("H13.1.1 - Remove if implemented");
    }

    /**
     * Parses an integer encoded in ASCII decimal as per PPM spec.
     * The decimals end is detected if there is a whitespace character.
     * The terminating whitespace character is also consumed from the stream
     *
     * @return the integer value of the parsed decimal
     * @throws IOException if an I/O error occur
     */
    @DoNotTouch
    private int parseWhitespaceTerminatedDecimal() throws IOException {
        StringBuilder decimal = new StringBuilder();

        int b;
        while (true) {
            b = input.read();
            if (b >= '0' && b <= '9') {
                int digit = b - '0';
                decimal.append(digit);
            } else if (Character.isWhitespace(b)) {
                break;
            } else {
                throw new PPMFormatException("Expected digit or whitespace");
            }
        }

        if (decimal.isEmpty()) {
            throw new PPMFormatException("Expected at least one decimal digit");
        }

        return Integer.parseInt(decimal.toString());
    }

    @DoNotTouch
    @Override
    public void close() throws IOException {
        input.close(); // close underlying stream
    }
}
